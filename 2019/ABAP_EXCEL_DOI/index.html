<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  
  
  
  
  
  <link rel="prev" href="https://coldinfire.github.io/2019/SAP_Utils_Webservice/" />
  <link rel="next" href="https://coldinfire.github.io/2019/ABAP_Memory/" />
  <link rel="canonical" href="https://coldinfire.github.io/2019/ABAP_EXCEL_DOI/" />
  <link rel='shortcut icon' type='image/x-icon' href='/favicon.ico' />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
            ABAP DOI 使用  | Small Fire`s Blog
       
  </title>
  <meta name="title" content=" ABAP DOI 使用  | Small Fire`s Blog">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=" ABAP DOI 使用 "/>
<meta name="twitter:description" content="概述 DOI（Desktop office Integration）采用 OO 的思想实现与 Office 的结合使用，通过 DOI 对文档进行操作和处理。SAP 标准DEMO： SAPR"/>

  <script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": " ABAP DOI 使用 ",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https:\/\/coldinfire.github.io\/2019\/ABAP_EXCEL_DOI\/"
  },
  "image": {
    "@type": "ImageObject",
    "url": "https:\/\/coldinfire.github.io\/cover.png",
    "width":  800 ,
    "height":  600 
  },
  "genre": "posts",
  "keywords": "abaputils, ALV",
  "wordcount":  4690 ,
  "url": "https:\/\/coldinfire.github.io\/2019\/ABAP_EXCEL_DOI\/",
  "datePublished": "2019-02-22T00:00:00\x2b00:00",
  "dateModified": "2019-02-22T00:00:00\x2b00:00",
  
  "publisher": {
    "@type": "Organization",
    "name": "SmallFire",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/coldinfire.github.io\/logo.png",
      "width":  127 ,
      "height":  40 
    }
  },
  "author": {
    "@type": "Person",
    "name": "Small Fire"
  },
  "description": ""
}
</script>
</head>

  



  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="https://coldinfire.github.io">Small Fire`s Blog</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/books/" title="">Books</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
                <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-sun"></i></a>&nbsp;
                <a href="/search/" class="search"><i class="iconfont icon-t"></i></a>&nbsp;
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-sun"></i></a>&nbsp;<a href="https://coldinfire.github.io">Small Fire`s Blog</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/books/" title="">Books</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>

    	 <main class="main">
          <div class="container">
      		
<article class="post-warp">
    <header class="post-header">
        <h1 class="post-title"> ABAP DOI 使用 </h1>
        <div class="post-meta">
            Written by <a href="https://coldinfire.github.io" rel="author">Small Fire</a> with ♥ 
                <span class="post-time">
                    on <time datetime=2019-02-22 >22 February 2019</time>
                </span>
                in
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        <a href="https://coldinfire.github.io/categories/ABAP/"> ABAP </a>
                        
                </span>
                <i class="iconfont icon-timer"></i>
                10 min
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          <h2 id="概述-">概述</h2>
<p>DOI（Desktop office Integration）采用 OO 的思想实现与 Office 的结合使用，通过 DOI 对文档进行操作和处理。SAP 标准DEMO： <code>SAPRDEMOEXCEL_EXPORT</code>、<code>SAPRDEMO_DOI_BDS</code>。</p>
<p>文档使用方式：</p>
<ul>
<li>先上传模板到服务器(OAOR)，然后由 DOI 对模板进行调用
<ul>
<li>OAOR：class name (HRFPM_EXCEL_STANDARD)、class type (OT)、object key</li>
</ul>
</li>
<li>通过代码直接创建 ExceL / Word 文档</li>
</ul>
<h4 id="doi-核心对象">DOI 核心对象</h4>
<ul>
<li>container：类型是 <code>cl_gui_custom_container</code>；存放 Excel 电子表格(spreadsheet)的容器，一般是程序中默认的 screen。标准的 container 接口的类型是 <code>cl_gui_container</code> 。</li>
<li>container control：类型是 <code>i_oi_container_control</code>；容器中用于创建和管理其他 Office 集成所需要的对象。</li>
<li>document proxy：类型是 <code>i_oi_document_proxy</code>；每一个 document proxy 的实例代表用 office application 打开的文档，如果想打开多个文档，需要定义多个实例。</li>
<li>spreadsheet: 类型是<code>i_oi_spreadsheet</code>；spreadsheet 接口代表最终要操作的 excel 文档。</li>
<li>errors：类型是 <code>i_oi_error</code>；异常的处理，保存操作时产生的异常信息</li>
<li>retcode ：类型是 <code>soi_ret_string</code>；执行方法时返回的消息字符串</li>
<li>splitter container：类型是<code>cl_gui_splitter_container</code>；动态的可以拆分的容器，可存放多个标准的(cl_gui_container)电子表格</li>
</ul>
<p>如果读取服务器上的文档模板，需要 <code>cl_bds_document_set</code> 类：</p>
<ul>
<li>business document set：类型<code>cl_bds_document_set</code>，用于管理后续要操作的文档，可以包含一个或多个文档。</li>
<li>link server：类型<code>i_oi_link_server</code>，连接服务器对象</li>
</ul>
<h4 id="doi-操作-excel-步骤">DOI 操作 Excel 步骤</h4>
<ol>
<li>获取 container 容器</li>
<li>创建 container control 对象实例并初始化</li>
<li>创建 document proxy 对象的实例</li>
<li>打开一个服务器上的模板文档或新建一个 excel 文档</li>
<li>操作 excel 文档，设置 excel 的属性或调用相关方法</li>
<li>退出时关闭 excel 文档，释放资源</li>
<li>异常信息管理</li>
</ol>
<h2 id="doi-定义和使用-">DOI 定义和使用</h2>
<h3 id="字段定义-">字段定义</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">TYPE-POOLS</span>: slis,soi,sbdst,vrm.
<span style="color:#66d9ef">CLASS</span> c_oi_errors <span style="color:#66d9ef">DEFINITION</span> <span style="color:#66d9ef">LOAD</span>.
<span style="color:#66d9ef">TYPES</span>:t_url <span style="color:#66d9ef">LIKE </span>bapiuri<span style="color:#f92672">-</span>uri.
<span style="color:#66d9ef">DATA</span>: fcode <span style="color:#66d9ef">LIKE </span>sy<span style="color:#f92672">-</span>ucomm.
<span style="color:#75715e">* SAP Desktop Office Integration Interfaces</span>
<span style="color:#66d9ef">DATA</span>: container <span style="color:#66d9ef">TYPE REF TO</span> cl_gui_container,
      custom_container <span style="color:#66d9ef">TYPE REF TO</span> cl_gui_custom_container,
      control   <span style="color:#66d9ef">TYPE REF TO</span> i_oi_container_control,
<span style="color:#75715e">*      document  TYPE REF TO i_oi_document_proxy,</span>
      spreadsheet_interface <span style="color:#66d9ef">TYPE REF TO</span> i_oi_spreadsheet,
      error     <span style="color:#66d9ef">TYPE REF TO</span> i_oi_error,
      retcode   <span style="color:#66d9ef">TYPE </span>soi_ret_string,
      splitter  <span style="color:#66d9ef">TYPE REF TO</span> cl_gui_splitter_container.
<span style="color:#75715e">* Spreadsheet Option Paramter</span>
<span style="color:#66d9ef">DATA</span>: document_type   <span style="color:#66d9ef">TYPE </span>soi_document_type,
      document_format <span style="color:#66d9ef">TYPE </span>soi_document_type.
<span style="color:#66d9ef">DATA</span>: is_open_inplace  <span style="color:#66d9ef">TYPE </span>i <span style="color:#66d9ef">VALUE</span> <span style="color:#ae81ff">0</span>,
      is_open_for_edit <span style="color:#66d9ef">TYPE </span>i <span style="color:#66d9ef">VALUE</span> <span style="color:#ae81ff">0</span>,
      is_available     <span style="color:#66d9ef">TYPE </span>i.
<span style="color:#75715e">* Spreadsheet interface structures for Excel data input</span>
<span style="color:#66d9ef">DATA</span>: gt_ranges      <span style="color:#66d9ef">TYPE </span>soi_range_list,
      gs_range       <span style="color:#66d9ef">LIKE LINE OF</span> gt_ranges,
      gt_contents    <span style="color:#66d9ef">TYPE </span>soi_generic_table,
      gs_contents    <span style="color:#66d9ef">LIKE LINE OF</span> gt_contents,
      g_initialized  <span style="color:#66d9ef">TYPE </span>c,
      gt_excel_format <span style="color:#66d9ef">TYPE </span>soi_format_table,
      gs_excel_format <span style="color:#66d9ef">LIKE LINE OF</span> gt_excel_format,
      gs_cellitem    <span style="color:#66d9ef">TYPE </span>soi_generic_item,
      gs_rangeitem   <span style="color:#66d9ef">TYPE </span>soi_range_item.
</code></pre></div><p>OAOR  模板方法参数定义</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#75715e">* OAOR Template parameter</span>
<span style="color:#66d9ef">DATA</span>: g_classname  <span style="color:#66d9ef">TYPE </span>sbdst_classname <span style="color:#66d9ef">VALUE</span> <span style="color:#e6db74">&#39;HRFPM_EXCEL_STANDARD&#39;</span>,
      g_classtype  <span style="color:#66d9ef">TYPE </span>sbdst_classtype <span style="color:#66d9ef">VALUE</span> <span style="color:#e6db74">&#39;OT&#39;</span>,
      g_objectkey  <span style="color:#66d9ef">TYPE </span>sbdst_object_key <span style="color:#66d9ef">VALUE</span> <span style="color:#e6db74">&#39;ZTEST&#39;</span>.
<span style="color:#75715e">&#34;BDS Method Parameter&#34;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">DATA</span>: bds_documents  <span style="color:#66d9ef">TYPE REF TO</span> cl_bds_document_set,
      link_server    <span style="color:#66d9ef">TYPE REF TO</span> i_oi_link_server,
      gt_doc_signature  <span style="color:#66d9ef">TYPE </span>sbdst_signature,
      gs_doc_signature  <span style="color:#66d9ef">LIKE LINE OF</span> gt_doc_signature,
      gt_doc_components <span style="color:#66d9ef">TYPE </span>sbdst_components,
      gs_doc_components <span style="color:#66d9ef">LIKE LINE OF</span> gt_doc_components,
      gt_bds_uris       <span style="color:#66d9ef">TYPE </span>sbdst_uri,
      gs_bds_uri        <span style="color:#66d9ef">LIKE LINE OF</span> gt_bds_uris,
      gt_doc_properties <span style="color:#66d9ef">TYPE </span>sbdst_properties,
      gs_doc_properties <span style="color:#66d9ef">LIKE LINE OF</span> gt_doc_properties,
      doc_mimetype      <span style="color:#66d9ef">TYPE </span>bapicompon<span style="color:#f92672">-</span>mimetype,
      template_url      <span style="color:#66d9ef">TYPE </span>t_url.
</code></pre></div><h3 id="创建-doi-">创建 DOI</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">CALL SCREEN</span> <span style="color:#ae81ff">100</span>.
<span style="color:#75715e">&#34;Screen 100 PBO &amp; PAI&#34;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">MODULE</span> <span style="color:#a6e22e">status_0100</span> <span style="color:#66d9ef">OUTPUT</span>.
  <span style="color:#66d9ef">SET PF-STATUS</span> <span style="color:#e6db74">&#39;MAIN0100&#39;</span>.
  <span style="color:#66d9ef">SET TITLEBAR</span> <span style="color:#e6db74">&#39;001&#39;</span>.
  <span style="color:#66d9ef">PERFORM</span> <span style="color:#a6e22e">get_dynamic_container</span>.
  <span style="color:#66d9ef">PERFORM</span> <span style="color:#a6e22e">create_container_control</span>.
<span style="color:#66d9ef">ENDMODULE</span>.                 <span style="color:#75715e">&#34; STATUS_0100  OUTPUT &#34;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">MODULE</span> <span style="color:#a6e22e">user_command_0100</span> <span style="color:#66d9ef">INPUT</span>.
  ...
<span style="color:#66d9ef">ENDMODULE</span>.                 <span style="color:#75715e">&#34; USER_COMMAND_0100  INPUT &#34;
</span><span style="color:#75715e"></span><span style="color:#75715e">&#34;DOI Define&#34;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">FORM</span> <span style="color:#a6e22e">get_dynamic_container</span>.
  <span style="color:#66d9ef">CREATE OBJECT</span> splitter
    <span style="color:#66d9ef">EXPORTING</span>
      parent  <span style="color:#f92672">=</span> cl_gui_container<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>screen0
      rows    <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
      columns <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>.
  <span style="color:#66d9ef">CALL METHOD</span> splitter<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>set_border
    <span style="color:#66d9ef">EXPORTING</span>
      border <span style="color:#f92672">=</span> cl_gui_cfw<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>false.
  container <span style="color:#f92672">=</span> splitter<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">get_container</span>( row <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> column <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> ).
<span style="color:#66d9ef">ENDFORM</span>.                    <span style="color:#75715e">&#34; GET_DYNAMIC_CONTAINER &#34;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">FORM</span> <span style="color:#a6e22e">create_container_control</span> .
  <span style="color:#66d9ef">IF</span> control <span style="color:#f92672">IS INITIAL</span>.
    <span style="color:#66d9ef">DATA</span>:l_has_activex.
    <span style="color:#66d9ef">CALL FUNCTION</span> <span style="color:#e6db74">&#39;GUI_HAS_ACTIVEX&#39;</span>
      <span style="color:#66d9ef">IMPORTING</span>
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">=</span> l_has_activex.
    <span style="color:#66d9ef">IF</span> l_has_activex <span style="color:#f92672">IS INITIAL</span>.
      <span style="color:#66d9ef">MESSAGE</span> <span style="color:#e6db74">&#39;Use a Windows GUI for this program&#39;</span> TYPE <span style="color:#e6db74">&#39;E&#39;</span>.
    <span style="color:#66d9ef">ENDIF</span>.
<span style="color:#75715e">*===== Get container (静态Container) =====*</span>
    <span style="color:#66d9ef">CREATE OBJECT</span> custom_container
      <span style="color:#66d9ef">EXPORTING</span>
        container_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;DOI_PARENT&#39;</span>. <span style="color:#75715e">&#34;100屏幕上的Custom Control控件名&#34;
</span><span style="color:#75715e"></span><span style="color:#75715e">*===== Get the SAP DOI container control interface =====*</span>
    <span style="color:#66d9ef">CALL METHOD</span> c_oi_container_control_creator<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>get_container_control
      <span style="color:#66d9ef">IMPORTING</span>
        control <span style="color:#f92672">=</span> control
        error   <span style="color:#f92672">=</span> error.
   <span style="color:#75715e">&#34;check no errors occured&#34;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">CALL METHOD</span> error<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>raise_message <span style="color:#66d9ef">EXPORTING</span> type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;E&#39;</span>.
<span style="color:#75715e">*===== Initialize the SAP DOI Container, tell it to run in the container =====*</span>
    <span style="color:#66d9ef">CALL METHOD</span> control<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>init_control
      <span style="color:#66d9ef">EXPORTING</span>
        inplace_enabled          <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>
        inplace_scroll_documents <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>
        register_on_close_event  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>
        register_on_custom_event <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>
        r3_application_name      <span style="color:#f92672">=</span> sy<span style="color:#f92672">-</span>repid
        parent                   <span style="color:#f92672">=</span> custom_container
        no_flush                 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>
      <span style="color:#66d9ef">IMPORTING</span>
        error                    <span style="color:#f92672">=</span> error.
    <span style="color:#75715e">&#34;check no errors occured&#34;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">CALL METHOD</span> error<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>raise_message <span style="color:#66d9ef">EXPORTING</span> type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;E&#39;</span>.
  <span style="color:#66d9ef">ENDIF</span>.
<span style="color:#66d9ef">ENDFORM</span>.                    <span style="color:#75715e">&#34; create_container_control &#34;
</span></code></pre></div><h3 id="对-document-进行操作-">对 Document 进行操作</h3>
<h4 id="自定义类并封装标准的方法">自定义类并封装标准的方法</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#75715e">*---------------------------------------------------------------------*</span>
<span style="color:#75715e">*       CLASS c_office_document DEFINITION</span>
<span style="color:#75715e">*---------------------------------------------------------------------*</span>
<span style="color:#66d9ef">CLASS</span> c_office_document <span style="color:#66d9ef">DEFINITION</span>.
  <span style="color:#66d9ef">PUBLIC SECTION</span>.
    <span style="color:#66d9ef">DATA</span>: proxy <span style="color:#66d9ef">TYPE REF TO</span> i_oi_document_proxy.
    <span style="color:#66d9ef">DATA</span>: document_type <span style="color:#66d9ef">TYPE </span>soi_document_type.
    <span style="color:#66d9ef">DATA</span>: document_format <span style="color:#66d9ef">TYPE </span>soi_document_type.
    <span style="color:#66d9ef">DATA</span>: has_changed_at_reopen <span style="color:#66d9ef">TYPE </span>i.
    <span style="color:#66d9ef">DATA</span>: data_table <span style="color:#66d9ef">TYPE </span>sbdst_content,
          data_size <span style="color:#66d9ef">TYPE </span>i,
          doc_url <span style="color:#66d9ef">TYPE </span>t_url.
<span style="color:#75715e">*   Constructor</span>
    <span style="color:#66d9ef">METHODS</span>: constructor
               <span style="color:#66d9ef">IMPORTING</span> control <span style="color:#66d9ef">TYPE REF TO</span> i_oi_container_control
                         document_type <span style="color:#66d9ef">TYPE </span>c
                         document_format <span style="color:#66d9ef">TYPE </span>c.
<span style="color:#75715e">*   Close Event Processor</span>
    <span style="color:#66d9ef">METHODS</span>: on_close_document
               <span style="color:#66d9ef">FOR EVENT</span> on_close_document <span style="color:#66d9ef">OF</span> i_oi_document_proxy
               <span style="color:#66d9ef">IMPORTING</span> document_proxy has_changed.
<span style="color:#75715e">*   Create Docuent: open_inplace控制文档是独立显示还是在SAP GUI中嵌入显示(X)</span>
    <span style="color:#66d9ef">METHODS</span>: create_document
               <span style="color:#66d9ef">IMPORTING</span> open_inplace  <span style="color:#66d9ef">TYPE </span>c <span style="color:#66d9ef">DEFAULT</span> <span style="color:#e6db74">&#39; &#39;</span>
               <span style="color:#66d9ef">EXPORTING</span> retcode <span style="color:#66d9ef">TYPE </span>soi_ret_string.
<span style="color:#75715e">*   Open Docuent</span>
    <span style="color:#66d9ef">METHODS</span>: open_document
               <span style="color:#66d9ef">IMPORTING</span> open_inplace  <span style="color:#66d9ef">TYPE </span>c <span style="color:#66d9ef">DEFAULT</span> <span style="color:#e6db74">&#39; &#39;</span>
                         open_readonly <span style="color:#66d9ef">TYPE </span>c <span style="color:#66d9ef">DEFAULT</span> <span style="color:#e6db74">&#39; &#39;</span>
                         doc_url <span style="color:#66d9ef">TYPE </span>t_url <span style="color:#66d9ef">DEFAULT</span> <span style="color:#e6db74">&#39; &#39;</span>
               <span style="color:#66d9ef">EXPORTING</span> retcode <span style="color:#66d9ef">TYPE </span>soi_ret_string.
<span style="color:#75715e">*   Re-Open Docuent</span>
    <span style="color:#66d9ef">METHODS</span>: reopen_document
               <span style="color:#66d9ef">IMPORTING</span> open_inplace  <span style="color:#66d9ef">TYPE </span>c <span style="color:#66d9ef">DEFAULT</span> <span style="color:#e6db74">&#39; &#39;</span>
               <span style="color:#66d9ef">EXPORTING</span> retcode <span style="color:#66d9ef">TYPE </span>soi_ret_string.
    <span style="color:#66d9ef">METHODS</span>: view_document
               <span style="color:#66d9ef">EXPORTING</span> retcode <span style="color:#66d9ef">TYPE </span>soi_ret_string.
<span style="color:#75715e">*   Close Docuent</span>
    <span style="color:#66d9ef">METHODS</span>: close_document
               <span style="color:#66d9ef">IMPORTING</span> do_save     <span style="color:#66d9ef">TYPE </span>c <span style="color:#66d9ef">DEFAULT</span> <span style="color:#e6db74">&#39; &#39;</span>
               <span style="color:#66d9ef">EXPORTING</span> retcode     <span style="color:#66d9ef">TYPE </span>soi_ret_string
                         error       <span style="color:#66d9ef">TYPE REF TO</span> i_oi_error.
<span style="color:#75715e">*   Check for availability of Spreadsheet interface</span>
    <span style="color:#66d9ef">METHODS</span>: has_spreadsheet_interface
               <span style="color:#66d9ef">EXPORTING</span> is_available <span style="color:#66d9ef">TYPE </span>i
                         retcode      <span style="color:#66d9ef">TYPE </span>soi_ret_string
                         error        <span style="color:#66d9ef">TYPE REF TO</span> i_oi_error.
<span style="color:#75715e">*   Get the Spreadsheet interface</span>
    <span style="color:#66d9ef">METHODS</span>: get_spreadsheet_interface
               <span style="color:#66d9ef">EXPORTING</span> retcode      <span style="color:#66d9ef">TYPE </span>soi_ret_string
                         error        <span style="color:#66d9ef">TYPE REF TO</span> i_oi_error.
<span style="color:#75715e">*   Method in Spreadsheet interface to set the data for ranges in Excel</span>
    <span style="color:#66d9ef">METHODS</span>: set_ranges_data
               <span style="color:#66d9ef">IMPORTING</span> <span style="color:#66d9ef">ranges</span>    <span style="color:#66d9ef">TYPE </span>soi_range_list
                         contents  <span style="color:#66d9ef">TYPE </span>soi_generic_table
               <span style="color:#66d9ef">EXPORTING</span> error     <span style="color:#66d9ef">TYPE REF TO</span> i_oi_error
                         retcode   <span style="color:#66d9ef">TYPE </span>soi_ret_string.
<span style="color:#75715e">*   Method in Spreadsheet interface to set the ranges in Excel</span>
    <span style="color:#66d9ef">METHODS</span>: insert_range
               <span style="color:#66d9ef">IMPORTING</span> rows    <span style="color:#66d9ef">TYPE </span>i
                         columns <span style="color:#66d9ef">TYPE </span>i
                         name    <span style="color:#66d9ef">TYPE </span>c
               <span style="color:#66d9ef">EXPORTING</span> error   <span style="color:#66d9ef">TYPE REF TO</span> i_oi_error
                         retcode <span style="color:#66d9ef">TYPE </span>soi_ret_string.
<span style="color:#75715e">*   Save the document at given URL.</span>
    <span style="color:#66d9ef">METHODS</span>: save_document_to_url
               <span style="color:#66d9ef">IMPORTING</span> url         <span style="color:#66d9ef">TYPE </span>t_url
               <span style="color:#66d9ef">EXPORTING</span> error       <span style="color:#66d9ef">TYPE REF TO</span> i_oi_error
                         retcode     <span style="color:#66d9ef">TYPE </span>soi_ret_string
               <span style="color:#66d9ef">CHANGING</span>  document_size <span style="color:#66d9ef">TYPE </span>i.
  <span style="color:#66d9ef">PRIVATE SECTION</span>.
    <span style="color:#66d9ef">DATA</span>: control <span style="color:#66d9ef">TYPE REF TO</span> i_oi_container_control.
<span style="color:#66d9ef">ENDCLASS</span>.                    <span style="color:#75715e">&#34;c_office_document DEFINITION&#34;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">DATA</span>: document <span style="color:#66d9ef">TYPE REF TO</span> c_office_document.

<span style="color:#75715e">************************************************************************</span>
<span style="color:#75715e">*  CLASS c_office_document IMPLEMENTATION.</span>
<span style="color:#75715e">************************************************************************</span>
<span style="color:#66d9ef">CLASS</span> c_office_document <span style="color:#66d9ef">IMPLEMENTATION</span>.
  <span style="color:#66d9ef">METHOD</span>: constructor.
<span style="color:#75715e">*              IMPORTING control TYPE REF TO i_oi_container_control</span>
<span style="color:#75715e">*                        document_type TYPE soi_document_type</span>
<span style="color:#75715e">*                        document_format TYPE soi_document_type</span>
    me<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>control <span style="color:#f92672">=</span> control.
    me<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>document_type <span style="color:#f92672">=</span> document_type.
    me<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>document_format <span style="color:#f92672">=</span> document_format.
  <span style="color:#66d9ef">ENDMETHOD</span>.                    <span style="color:#75715e">&#34;constructor&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">METHOD</span> <span style="color:#a6e22e">create_document</span>.
<span style="color:#75715e">*              IMPORTING open_inplace  TYPE c DEFAULT &#39; &#39;</span>
<span style="color:#75715e">*              RETURNING value(retcode) TYPE t_oi_ret_string.</span>
    <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> proxy <span style="color:#f92672">IS INITIAL</span>.
      <span style="color:#66d9ef">CALL METHOD</span> me<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>close_document.
    <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">CALL METHOD</span> control<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>get_document_proxy
      <span style="color:#66d9ef">EXPORTING</span>
        document_type   <span style="color:#f92672">=</span> document_type
        document_format <span style="color:#f92672">=</span> document_format
      <span style="color:#66d9ef">IMPORTING</span>
        document_proxy  <span style="color:#f92672">=</span> proxy
        retcode         <span style="color:#f92672">=</span> retcode.
    <span style="color:#66d9ef">IF</span> retcode <span style="color:#f92672">NE</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_ok.
      <span style="color:#66d9ef">EXIT</span>.
    <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">CALL METHOD</span> proxy<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>create_document
      <span style="color:#66d9ef">EXPORTING</span>
        create_view_data <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>
        open_inplace     <span style="color:#f92672">=</span> open_inplace
      <span style="color:#66d9ef">IMPORTING</span>
        retcode          <span style="color:#f92672">=</span> retcode.
    <span style="color:#66d9ef">IF</span> retcode <span style="color:#f92672">NE</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_ok.
      <span style="color:#66d9ef">EXIT</span>.
    <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">SET HANDLER</span> me<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>on_close_document <span style="color:#66d9ef">FOR</span> proxy.
  <span style="color:#66d9ef">ENDMETHOD</span>.                    <span style="color:#75715e">&#34;create_document&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">METHOD</span> <span style="color:#a6e22e">open_document</span>.
<span style="color:#75715e">*                 IMPORTING open_inplace  TYPE c DEFAULT &#39; &#39;</span>
<span style="color:#75715e">*                           open_readonly TYPE c DEFAULT &#39; &#39;</span>
<span style="color:#75715e">*                           doc_url TYPE t_url DEFAULT &#39; &#39;</span>
<span style="color:#75715e">*                 RETURNING value(retcode) TYPE t_oi_ret_string.</span>
    <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> proxy <span style="color:#f92672">IS INITIAL</span>.
      <span style="color:#66d9ef">CALL METHOD</span> me<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>close_document.
    <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">CALL METHOD</span> control<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>get_document_proxy
      <span style="color:#66d9ef">EXPORTING</span>
        document_type   <span style="color:#f92672">=</span> document_type
        document_format <span style="color:#f92672">=</span> document_format
      <span style="color:#66d9ef">IMPORTING</span>
        document_proxy  <span style="color:#f92672">=</span> proxy
        retcode         <span style="color:#f92672">=</span> retcode.
    <span style="color:#66d9ef">IF</span> retcode <span style="color:#f92672">NE</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_ok.
      <span style="color:#66d9ef">EXIT</span>.
    <span style="color:#66d9ef">ENDIF</span>.
    me<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>doc_url <span style="color:#f92672">=</span> doc_url.
    <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> doc_url <span style="color:#f92672">IS INITIAL</span>.
      <span style="color:#66d9ef">CALL METHOD</span> proxy<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>open_document
        <span style="color:#66d9ef">EXPORTING</span>
          document_url  <span style="color:#f92672">=</span> doc_url
          open_inplace  <span style="color:#f92672">=</span> open_inplace
          open_readonly <span style="color:#f92672">=</span> open_readonly
        <span style="color:#66d9ef">IMPORTING</span>
          retcode       <span style="color:#f92672">=</span> retcode.
      <span style="color:#66d9ef">IF</span> retcode <span style="color:#f92672">NE</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_ok.
        <span style="color:#66d9ef">EXIT</span>.
      <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">ELSE</span>.
      <span style="color:#66d9ef">CALL METHOD</span> proxy<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>open_document_from_table
        <span style="color:#66d9ef">EXPORTING</span>
          document_table <span style="color:#f92672">=</span> data_table
          document_size  <span style="color:#f92672">=</span> data_size
          open_inplace   <span style="color:#f92672">=</span> open_inplace
          open_readonly  <span style="color:#f92672">=</span> open_readonly
        <span style="color:#66d9ef">IMPORTING</span>
          retcode        <span style="color:#f92672">=</span> retcode.
      <span style="color:#66d9ef">IF</span> retcode <span style="color:#f92672">NE</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_ok.
        <span style="color:#66d9ef">EXIT</span>.
      <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">SET HANDLER</span> me<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>on_close_document <span style="color:#66d9ef">FOR</span> proxy.
  <span style="color:#66d9ef">ENDMETHOD</span>.                    <span style="color:#75715e">&#34;open_document&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">METHOD</span> <span style="color:#a6e22e">reopen_document</span>.
<span style="color:#75715e">*                 IMPORTING open_inplace  TYPE c DEFAULT &#39; &#39;</span>
<span style="color:#75715e">*                 RETURNING value(retcode) TYPE t_oi_ret_string.</span>
    <span style="color:#66d9ef">DATA</span>: l_has_changed <span style="color:#66d9ef">TYPE </span>i.
    <span style="color:#66d9ef">CALL METHOD</span> proxy<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>reopen_document
      <span style="color:#66d9ef">EXPORTING</span>
        open_inplace <span style="color:#f92672">=</span> open_inplace
      <span style="color:#66d9ef">IMPORTING</span>
        has_changed  <span style="color:#f92672">=</span> l_has_changed
        retcode      <span style="color:#f92672">=</span> retcode.
    <span style="color:#66d9ef">IF</span> retcode <span style="color:#f92672">NE</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_ok.
      <span style="color:#66d9ef">EXIT</span>.
    <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> l_has_changed <span style="color:#f92672">IS INITIAL</span>.
      has_changed_at_reopen <span style="color:#f92672">=</span> l_has_changed.
    <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">SET HANDLER</span> me<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>on_close_document <span style="color:#66d9ef">FOR</span> proxy.
  <span style="color:#66d9ef">ENDMETHOD</span>.                    <span style="color:#75715e">&#34;reopen_document&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">METHOD</span> <span style="color:#a6e22e">view_document</span>.
<span style="color:#75715e">*                 RETURNING value(retcode) TYPE t_oi_ret_string.</span>
    <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> proxy <span style="color:#f92672">IS INITIAL</span>.
      <span style="color:#66d9ef">CALL METHOD</span> me<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>close_document.
    <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">CALL METHOD</span> control<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>get_document_proxy
      <span style="color:#66d9ef">EXPORTING</span>
        document_type   <span style="color:#f92672">=</span> document_type
        document_format <span style="color:#f92672">=</span> document_format
      <span style="color:#66d9ef">IMPORTING</span>
        document_proxy  <span style="color:#f92672">=</span> proxy
        retcode         <span style="color:#f92672">=</span> retcode.
    <span style="color:#66d9ef">IF</span> retcode <span style="color:#f92672">NE</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_ok.
      <span style="color:#66d9ef">EXIT</span>.
    <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">CALL METHOD</span> proxy<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>view_document_from_table
      <span style="color:#66d9ef">EXPORTING</span>
        document_table <span style="color:#f92672">=</span> data_table
        document_size  <span style="color:#f92672">=</span> data_size
        open_inplace   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>
      <span style="color:#66d9ef">IMPORTING</span>
        retcode        <span style="color:#f92672">=</span> retcode.
    <span style="color:#66d9ef">IF</span> retcode <span style="color:#f92672">NE</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_ok.
      <span style="color:#66d9ef">EXIT</span>.
    <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">SET HANDLER</span> me<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>on_close_document <span style="color:#66d9ef">FOR</span> proxy.
  <span style="color:#66d9ef">ENDMETHOD</span>.                    <span style="color:#75715e">&#34;view_document&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">METHOD</span> <span style="color:#a6e22e">close_document</span>.
<span style="color:#75715e">*                 IMPORTING do_save TYPE c DEFAULT &#39; &#39;</span>
<span style="color:#75715e">*                 RETURNING value(retcode) TYPE t_oi_ret_string.</span>
    <span style="color:#66d9ef">DATA</span>: has_changed <span style="color:#66d9ef">TYPE </span>i, is_closed <span style="color:#66d9ef">TYPE </span>i.
    <span style="color:#66d9ef">DATA</span>: save_error <span style="color:#66d9ef">TYPE REF TO</span> i_oi_error.
    <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> proxy <span style="color:#f92672">IS INITIAL</span>.
      <span style="color:#66d9ef">CALL METHOD</span> proxy<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>is_destroyed
        <span style="color:#66d9ef">IMPORTING</span>
          ret_value <span style="color:#f92672">=</span> is_closed.
      <span style="color:#66d9ef">IF</span> is_closed <span style="color:#f92672">IS INITIAL</span>.
        <span style="color:#66d9ef">CALL METHOD</span> proxy<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>close_document
          <span style="color:#66d9ef">EXPORTING</span>
            do_save     <span style="color:#f92672">=</span> do_save
          <span style="color:#66d9ef">IMPORTING</span>
            has_changed <span style="color:#f92672">=</span> has_changed
            retcode     <span style="color:#f92672">=</span> retcode
            error       <span style="color:#f92672">=</span> error.
        <span style="color:#66d9ef">IF</span> retcode <span style="color:#f92672">NE</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_ok.
          <span style="color:#66d9ef">EXIT</span>.
        <span style="color:#66d9ef">ENDIF</span>.
      <span style="color:#66d9ef">ENDIF</span>.
      <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> has_changed <span style="color:#f92672">IS INITIAL</span> <span style="color:#f92672">OR</span>
                       ( <span style="color:#f92672">NOT</span> has_changed_at_reopen <span style="color:#f92672">IS INITIAL</span> <span style="color:#f92672">AND</span>
                         <span style="color:#f92672">NOT</span> do_save <span style="color:#f92672">IS INITIAL</span> ).
        <span style="color:#66d9ef">CALL METHOD</span> proxy<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>save_document_to_table
          <span style="color:#66d9ef">EXPORTING</span>
            no_flush       <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>
          <span style="color:#66d9ef">IMPORTING</span>
            error          <span style="color:#f92672">=</span> save_error
          <span style="color:#66d9ef">CHANGING</span>
            document_table <span style="color:#f92672">=</span> data_table
            document_size  <span style="color:#f92672">=</span> data_size.
      <span style="color:#66d9ef">ENDIF</span>.
      <span style="color:#66d9ef">CALL METHOD</span> proxy<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>release_document
        <span style="color:#66d9ef">IMPORTING</span>
          retcode <span style="color:#f92672">=</span> retcode
          error   <span style="color:#f92672">=</span> error.
      <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> save_error <span style="color:#f92672">IS INITIAL</span>.
        <span style="color:#66d9ef">IF</span> save_error<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>error_code <span style="color:#f92672">NE</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_ok.
          <span style="color:#66d9ef">CALL METHOD</span> save_error<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>flush_error.
          retcode <span style="color:#f92672">=</span> save_error<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>error_code.
          error <span style="color:#f92672">=</span> save_error.
        <span style="color:#66d9ef">ENDIF</span>.
      <span style="color:#66d9ef">ENDIF</span>.
      <span style="color:#66d9ef">CLEAR</span>: has_changed_at_reopen.
      <span style="color:#66d9ef">SET HANDLER</span> me<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>on_close_document <span style="color:#66d9ef">FOR</span> proxy ACTIVATION <span style="color:#e6db74">&#39; &#39;</span>.
    <span style="color:#66d9ef">ELSE</span>.
      retcode <span style="color:#f92672">=</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_document_not_open.
    <span style="color:#66d9ef">ENDIF</span>.
  <span style="color:#66d9ef">ENDMETHOD</span>.                    <span style="color:#75715e">&#34;close_document&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">METHOD</span> <span style="color:#a6e22e">on_close_document</span>.
<span style="color:#75715e">*              FOR EVENT on_close_document OF c_oi_container_control</span>
<span style="color:#75715e">*              IMPORTING document_proxy has_changed.</span>
    <span style="color:#66d9ef">DATA</span>: answer, do_save.
    <span style="color:#66d9ef">DATA</span>: save_error <span style="color:#66d9ef">TYPE REF TO</span> i_oi_error.
    is_open_inplace <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>. is_open_for_edit <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>.
    <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> has_changed <span style="color:#f92672">IS INITIAL</span> <span style="color:#f92672">OR</span> <span style="color:#f92672">NOT</span> has_changed_at_reopen <span style="color:#f92672">IS INITIAL</span>.
      do_save <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>.
      <span style="color:#66d9ef">CALL METHOD</span> me<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>close_document
        <span style="color:#66d9ef">EXPORTING</span>
          do_save <span style="color:#f92672">=</span> do_save
        <span style="color:#66d9ef">IMPORTING</span>
          error   <span style="color:#f92672">=</span> save_error.
      <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> save_error <span style="color:#f92672">IS INITIAL</span>.
        <span style="color:#66d9ef">CALL METHOD</span> save_error<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>raise_message
          <span style="color:#66d9ef">EXPORTING</span>
            type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;E&#39;</span>.
      <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">ENDIF</span>.
  <span style="color:#66d9ef">ENDMETHOD</span>.                    <span style="color:#75715e">&#34;on_close_document&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">METHOD</span> <span style="color:#a6e22e">has_spreadsheet_interface</span>.
<span style="color:#75715e">*                  EXPORTING is_available TYPE i</span>
<span style="color:#75715e">*                            retcode      TYPE soi_ret_string</span>
<span style="color:#75715e">*                            error        TYPE REF TO i_oi_error.</span>
    <span style="color:#66d9ef">CALL METHOD</span> proxy<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>has_spreadsheet_interface
      <span style="color:#66d9ef">IMPORTING</span>
        is_available <span style="color:#f92672">=</span> is_available
        error        <span style="color:#f92672">=</span> error
        retcode      <span style="color:#f92672">=</span> retcode.
    <span style="color:#66d9ef">IF</span> retcode <span style="color:#f92672">NE</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_ok.
      <span style="color:#66d9ef">EXIT</span>.
    <span style="color:#66d9ef">ENDIF</span>.
  <span style="color:#66d9ef">ENDMETHOD</span>.                    <span style="color:#75715e">&#34;has_spreadsheet_interface&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">METHOD</span> <span style="color:#a6e22e">get_spreadsheet_interface</span>.
<span style="color:#75715e">*                 EXPORTING sheet_interface TYPE REF to i_oi_spreadsheet</span>
<span style="color:#75715e">*                           retcode         TYPE soi_ret_string</span>
<span style="color:#75715e">*                           error           TYPE REF TO i_oi_error.</span>
    <span style="color:#66d9ef">CALL METHOD</span> proxy<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>get_spreadsheet_interface
      <span style="color:#66d9ef">IMPORTING</span>
        sheet_interface <span style="color:#f92672">=</span> spreadsheet_interface
        error           <span style="color:#f92672">=</span> error
        retcode         <span style="color:#f92672">=</span> retcode.
    <span style="color:#66d9ef">IF</span> retcode <span style="color:#f92672">NE</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_ok.
      <span style="color:#66d9ef">EXIT</span>.
    <span style="color:#66d9ef">ENDIF</span>.
  <span style="color:#66d9ef">ENDMETHOD</span>.                    <span style="color:#75715e">&#34;get_spreadsheet_interface&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">METHOD</span> <span style="color:#a6e22e">set_ranges_data</span>.
<span style="color:#75715e">*                 IMPORTING ranges    TYPE soi_range_list</span>
<span style="color:#75715e">*                           contents  TYPE soi_generic_table</span>
<span style="color:#75715e">*                 EXPORTING error     TYPE REF TO i_oi_error</span>
<span style="color:#75715e">*                           retcode   TYPE soi_ret_string.</span>
    <span style="color:#66d9ef">CALL METHOD</span> spreadsheet_interface<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>set_ranges_data
      <span style="color:#66d9ef">EXPORTING</span>
        <span style="color:#66d9ef">ranges</span>   <span style="color:#f92672">=</span> <span style="color:#66d9ef">ranges</span>
        contents <span style="color:#f92672">=</span> contents
      <span style="color:#66d9ef">IMPORTING</span>
        error    <span style="color:#f92672">=</span> error
        retcode  <span style="color:#f92672">=</span> retcode.
    <span style="color:#66d9ef">IF</span> retcode <span style="color:#f92672">NE</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_ok.
      <span style="color:#66d9ef">EXIT</span>.
    <span style="color:#66d9ef">ENDIF</span>.
  <span style="color:#66d9ef">ENDMETHOD</span>.                    <span style="color:#75715e">&#34;set_ranges_data&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">METHOD</span> <span style="color:#a6e22e">insert_range</span>.
<span style="color:#75715e">*                IMPORTING rows    TYPE i</span>
<span style="color:#75715e">*                          columns TYPE i</span>
<span style="color:#75715e">*                          name    TYPE c</span>
<span style="color:#75715e">*                EXPORTING error   TYPE REF TO i_oi_error</span>
<span style="color:#75715e">*                          retcode TYPE soi_ret_string.</span>
    <span style="color:#66d9ef">CALL METHOD</span> spreadsheet_interface<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>insert_range
      <span style="color:#66d9ef">EXPORTING</span>
        name    <span style="color:#f92672">=</span> name
        rows    <span style="color:#f92672">=</span> rows
        columns <span style="color:#f92672">=</span> columns
      <span style="color:#66d9ef">IMPORTING</span>
        error   <span style="color:#f92672">=</span> error
        retcode <span style="color:#f92672">=</span> retcode.
    <span style="color:#66d9ef">IF</span> retcode <span style="color:#f92672">NE</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_ok.
      <span style="color:#66d9ef">EXIT</span>.
    <span style="color:#66d9ef">ENDIF</span>.
  <span style="color:#66d9ef">ENDMETHOD</span>.                    <span style="color:#75715e">&#34;insert_range&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">METHOD</span> <span style="color:#a6e22e">save_document_to_url</span>.
    <span style="color:#66d9ef">CALL METHOD</span> proxy<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>save_document_to_url
      <span style="color:#66d9ef">EXPORTING</span>
        url           <span style="color:#f92672">=</span> url
      <span style="color:#66d9ef">IMPORTING</span>
        retcode       <span style="color:#f92672">=</span> retcode
      <span style="color:#66d9ef">CHANGING</span>
        document_size <span style="color:#f92672">=</span> document_size.
    <span style="color:#66d9ef">IF</span> retcode <span style="color:#f92672">NE</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_ok.
      <span style="color:#66d9ef">EXIT</span>.
    <span style="color:#66d9ef">ENDIF</span>.
  <span style="color:#66d9ef">ENDMETHOD</span>.                    <span style="color:#75715e">&#34;save_document_to_url&#34;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">ENDCLASS</span>.                    <span style="color:#75715e">&#34;c_office_document IMPLEMENTATION&#34;
</span></code></pre></div><h4 id="使用自定义类操作-document">使用自定义类操作 Document</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">MODULE</span> <span style="color:#a6e22e">user_command_0100</span> <span style="color:#66d9ef">INPUT</span>.
  <span style="color:#66d9ef">DATA</span>: l_fcode <span style="color:#66d9ef">LIKE </span>fcode.
  l_fcode <span style="color:#f92672">=</span> fcode.
  <span style="color:#66d9ef">CLEAR</span> fcode.
  <span style="color:#66d9ef">CALL METHOD</span> cl_gui_cfw<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>dispatch.
  <span style="color:#66d9ef">CASE</span> l_fcode.
    <span style="color:#66d9ef">WHEN</span> <span style="color:#e6db74">&#39;CREATE&#39;</span>.
<span style="color:#75715e">*    Create a New Excel Document</span>
      <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> control <span style="color:#f92672">IS INITIAL</span>.
        <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> document <span style="color:#f92672">IS INITIAL</span>.
          <span style="color:#66d9ef">CALL METHOD</span> document<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>close_document.
        <span style="color:#66d9ef">ENDIF</span>.
        document_type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Excel.Sheet.8&#39;</span>.
        document_format <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;OLE&#39;</span>. <span style="color:#75715e">&#34;soi_docformat_compound&#34;
</span><span style="color:#75715e"></span>        <span style="color:#75715e">&#34; 实例化自定义对象，通过对象的方法操作 Document &#34;
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">CREATE OBJECT</span> document
                    <span style="color:#66d9ef">EXPORTING</span> control <span style="color:#f92672">=</span> control
                              document_type <span style="color:#f92672">=</span> document_type
                              document_format <span style="color:#f92672">=</span> document_format.
        <span style="color:#66d9ef">CALL METHOD</span> document<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>create_document
                    <span style="color:#66d9ef">EXPORTING</span> open_inplace <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>
                    <span style="color:#66d9ef">IMPORTING</span> retcode <span style="color:#f92672">=</span> retcode.
        <span style="color:#66d9ef">CALL METHOD</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>raise_message <span style="color:#66d9ef">EXPORTING</span> type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;E&#39;</span>.
        is_open_inplace <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>. is_open_for_edit <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>.
      <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">WHEN</span> <span style="color:#e6db74">&#39;EXIT&#39;</span>.
<span style="color:#75715e">*    Close the Document and Release Control then Leave Program.</span>
      <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> document <span style="color:#f92672">IS INITIAL</span>.
        <span style="color:#66d9ef">CALL METHOD</span> document<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>close_document.
        <span style="color:#66d9ef">FREE </span>document.
      <span style="color:#66d9ef">ENDIF</span>.
      <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> control <span style="color:#f92672">IS INITIAL</span>.
        <span style="color:#66d9ef">CALL METHOD</span> control<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>destroy_control <span style="color:#66d9ef">IMPORTING</span> retcode <span style="color:#f92672">=</span> retcode.
        <span style="color:#66d9ef">FREE </span>control.
      <span style="color:#66d9ef">ENDIF</span>.
      <span style="color:#66d9ef">LEAVE</span> <span style="color:#66d9ef">PROGRAM</span>.
    <span style="color:#66d9ef">WHEN</span> <span style="color:#e6db74">&#39;OPEN&#39;</span>.
      <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> document <span style="color:#f92672">IS INITIAL</span> <span style="color:#f92672">AND</span> document<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data_size <span style="color:#f92672">NE</span> <span style="color:#ae81ff">0</span>.
        <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> control <span style="color:#f92672">IS INITIAL</span>.
          <span style="color:#66d9ef">IF</span> is_open_for_edit <span style="color:#f92672">EQ</span> <span style="color:#ae81ff">1</span>.
            <span style="color:#66d9ef">CALL METHOD</span> document<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>reopen_document
                        <span style="color:#66d9ef">IMPORTING</span> retcode <span style="color:#f92672">=</span> retcode.
          <span style="color:#66d9ef">ELSE</span>.
            <span style="color:#66d9ef">CALL METHOD</span> document<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>open_document
                        <span style="color:#66d9ef">IMPORTING</span> retcode <span style="color:#f92672">=</span> retcode.
          <span style="color:#66d9ef">ENDIF</span>.
          <span style="color:#66d9ef">CALL METHOD</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>raise_message <span style="color:#66d9ef">EXPORTING</span> type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;E&#39;</span>.
          is_open_inplace <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>. is_open_for_edit <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>.
        <span style="color:#66d9ef">ENDIF</span>.
      <span style="color:#66d9ef">ELSE</span>.
        <span style="color:#66d9ef">MESSAGE</span> <span style="color:#e6db74">&#39;First craete and save the excel document once&#39;</span> TYPE <span style="color:#e6db74">&#39;W&#39;</span>.
      <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">WHEN</span> <span style="color:#e6db74">&#39;VIEW&#39;</span>.
      <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> document <span style="color:#f92672">IS INITIAL</span> <span style="color:#f92672">AND</span> document<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data_size <span style="color:#f92672">NE</span> <span style="color:#ae81ff">0</span>.
        <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> control <span style="color:#f92672">IS INITIAL</span>.
          <span style="color:#66d9ef">CALL METHOD</span> document<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>view_document
                            <span style="color:#66d9ef">IMPORTING</span> retcode <span style="color:#f92672">=</span> retcode.
          is_open_inplace <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>. is_open_for_edit <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>.
          <span style="color:#66d9ef">CALL METHOD</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>raise_message <span style="color:#66d9ef">EXPORTING</span> type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;E&#39;</span>.
        <span style="color:#66d9ef">ENDIF</span>.
      <span style="color:#66d9ef">ELSE</span>.
        <span style="color:#66d9ef">MESSAGE</span> <span style="color:#e6db74">&#39;Please create a document first!&#39;</span> TYPE <span style="color:#e6db74">&#39;E&#39;</span>.
      <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">WHEN</span> <span style="color:#e6db74">&#39;CLOSE&#39;</span>.
      <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> document <span style="color:#f92672">IS INITIAL</span>.
        <span style="color:#66d9ef">DATA</span>: error <span style="color:#66d9ef">TYPE REF TO</span> i_oi_error.
        <span style="color:#66d9ef">CALL METHOD</span> document<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>close_document
                      <span style="color:#66d9ef">EXPORTING</span> do_save <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>
                      <span style="color:#66d9ef">IMPORTING</span> error <span style="color:#f92672">=</span> error.
        is_open_inplace <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>. is_open_for_edit <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>.
        <span style="color:#66d9ef">CALL METHOD</span> error<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>raise_message <span style="color:#66d9ef">EXPORTING</span> type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;W&#39;</span>.
      <span style="color:#66d9ef">ELSE</span>.
        <span style="color:#66d9ef">MESSAGE</span> <span style="color:#e6db74">&#39;No document being processed&#39;</span> TYPE <span style="color:#e6db74">&#39;E&#39;</span>.
      <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">WHEN</span> <span style="color:#e6db74">&#39;SAVEDOC&#39;</span>.
      <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> document <span style="color:#f92672">IS INITIAL</span>.
         <span style="color:#66d9ef">DATA</span> : document_size <span style="color:#66d9ef">TYPE </span>I.
         <span style="color:#66d9ef">CALL METHOD</span> document<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>save_document_to_url
               <span style="color:#66d9ef">EXPORTING</span> url           <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;FILE://C:\temp\TESTEXPORT.xls&#39;</span>
               <span style="color:#66d9ef">CHANGING</span>  document_size <span style="color:#f92672">=</span> document_size.
        <span style="color:#66d9ef">MESSAGE</span> <span style="color:#e6db74">&#39;Document is Exported to C:\temp\TESTEXPORT.xls&#39;</span> TYPE <span style="color:#e6db74">&#39;I&#39;</span>.
      <span style="color:#66d9ef">ELSE</span>.
        <span style="color:#66d9ef">MESSAGE</span> <span style="color:#e6db74">&#39;Please create a document first!&#39;</span> TYPE <span style="color:#e6db74">&#39;E&#39;</span>.
      <span style="color:#66d9ef">ENDIF</span>.

  <span style="color:#66d9ef">ENDCASE</span>.
<span style="color:#66d9ef">ENDMODULE</span>.                 <span style="color:#75715e">&#34; USER_COMMAND_0100  INPUT &#34;
</span></code></pre></div><h4 id="操作模板文档">操作模板文档</h4>
<p>操作 excel 模板文档，使用 cl_bds_document_set 类，这个类的 get_with_url 方法获取文档的 url。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#75715e">* Business document system</span>
<span style="color:#75715e">*===== Server Link Check =====*</span>
<span style="color:#66d9ef">CALL METHOD</span> control<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>get_link_server
  <span style="color:#66d9ef">EXPORTING</span>
    no_flush    <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>
  <span style="color:#66d9ef">IMPORTING</span>
    link_server <span style="color:#f92672">=</span> link_server
    error       <span style="color:#f92672">=</span> error.
<span style="color:#66d9ef">CALL METHOD</span> link_server<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>start_link_server
  <span style="color:#66d9ef">EXPORTING</span>
    no_flush <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>
  <span style="color:#66d9ef">IMPORTING</span>
    error    <span style="color:#f92672">=</span> error.
<span style="color:#75715e">*===== Create BDS Object =====*</span>
<span style="color:#66d9ef">IF</span> bds_documents <span style="color:#f92672">IS INITIAL</span>.
  <span style="color:#66d9ef">CREATE OBJECT</span> bds_documents.
<span style="color:#66d9ef">ENDIF</span>.
<span style="color:#75715e">*===== Get template info =====*</span>
<span style="color:#66d9ef">CALL METHOD</span> bds_documents<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>get_info  <span style="color:#75715e">&#34;_newest_only  &#34;alternativly
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">EXPORTING</span>
    classname  <span style="color:#f92672">=</span> g_classname
    classtype  <span style="color:#f92672">=</span> g_classtype
    object_key <span style="color:#f92672">=</span> g_objectkey
  <span style="color:#66d9ef">CHANGING</span>
    <span style="color:#66d9ef">components</span> <span style="color:#f92672">=</span> gt_doc_components
    signature  <span style="color:#f92672">=</span> gt_doc_signature.
  <span style="color:#66d9ef">EXCEPTIONS</span>
    nothing_found <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
    error_kpro    <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>.
<span style="color:#66d9ef">IF</span> sy<span style="color:#f92672">-</span>subrc <span style="color:#f92672">NE</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">AND</span> sy<span style="color:#f92672">-</span>subrc <span style="color:#f92672">NE</span> <span style="color:#ae81ff">1</span>.
  <span style="color:#66d9ef">MESSAGE</span> <span style="color:#e6db74">&#39;Error in the Business Document Service (BDS)&#39;</span> TYPE <span style="color:#e6db74">&#39;E&#39;</span>.
<span style="color:#66d9ef">ENDIF</span>.
gs_doc_signature<span style="color:#f92672">-</span>prop_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;DESCRIPTION&#39;</span>.
<span style="color:#66d9ef">LOOP AT </span>doc_signature <span style="color:#66d9ef">INTO</span> wa_doc_signature <span style="color:#66d9ef">WHERE</span> prop_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;DESCRIPTION&#39;</span>.
  gs_doc_signature<span style="color:#f92672">-</span>prop_value <span style="color:#f92672">=</span> wa_doc_signature<span style="color:#f92672">-</span>prop_value.
<span style="color:#66d9ef">ENDLOOP</span>.
<span style="color:#66d9ef">APPEND</span> gs_doc_signature <span style="color:#66d9ef">TO</span> gt_doc_signature.
<span style="color:#66d9ef">CLEAR</span> gs_doc_signature.
<span style="color:#75715e">* READ TABLE gt_doc_components INTO gs_doc_components INDEX 1.</span>
<span style="color:#75715e">* doc_mimetype = gs_doc_components-mimetype.</span>
<span style="color:#75715e">*===== Get template url =====*</span>
<span style="color:#66d9ef">CLEAR</span>: gt_bds_uris[],gs_bds_uri.
<span style="color:#66d9ef">CALL METHOD</span> bds_documents<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>get_with_url
  <span style="color:#66d9ef">EXPORTING</span>
    classname  <span style="color:#f92672">=</span> g_classname
    classtype  <span style="color:#f92672">=</span> g_classtype
    object_key <span style="color:#f92672">=</span> g_objectkey
  <span style="color:#66d9ef">CHANGING</span>
    uris       <span style="color:#f92672">=</span> gt_bds_uris
    signature  <span style="color:#f92672">=</span> gt_doc_signature.
  <span style="color:#66d9ef">EXCEPTIONS</span>
    nothing_found   <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
    error_kpro      <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
    internal_error  <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
    parameter_error <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>
    not_authorized  <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
    not_allowed     <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>.
<span style="color:#66d9ef">IF</span> sy<span style="color:#f92672">-</span>subrc <span style="color:#f92672">NE</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">AND</span> sy<span style="color:#f92672">-</span>subrc <span style="color:#f92672">NE</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">AND</span> sy<span style="color:#f92672">-</span>subrc <span style="color:#f92672">NE</span> <span style="color:#ae81ff">6</span>.
  <span style="color:#66d9ef">MESSAGE</span> <span style="color:#e6db74">&#39;Error in the Business Document Service (BDS)&#39;</span> TYPE <span style="color:#e6db74">&#39;S&#39;</span> DISPLAY LIKE <span style="color:#e6db74">&#39;E&#39;</span>.
  <span style="color:#66d9ef">LEAVE TO SCREEN</span> <span style="color:#ae81ff">0</span>.
<span style="color:#66d9ef">ENDIF</span>.
<span style="color:#66d9ef">READ</span> <span style="color:#66d9ef">TABLE</span> gt_bds_uris <span style="color:#66d9ef">INTO</span> gs_bds_uri <span style="color:#66d9ef">INDEX</span> <span style="color:#ae81ff">1</span>.
template_url <span style="color:#f92672">=</span> gs_bds_uri<span style="color:#f92672">-</span>uri.
<span style="color:#75715e">*===== Open the Excel =====*</span>
<span style="color:#66d9ef">CREATE OBJECT</span> document
  <span style="color:#66d9ef">EXPORTING</span>
    control        <span style="color:#f92672">=</span> control
    document_type  <span style="color:#f92672">=</span> document_type
    document_format <span style="color:#f92672">=</span> document_format.
<span style="color:#66d9ef">CALL METHOD</span> document<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>close_document.
<span style="color:#66d9ef">CALL METHOD</span> document<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>open_document
   <span style="color:#66d9ef">EXPORTING</span>
     open_inplace <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>
     document_url <span style="color:#f92672">=</span> template_url
   <span style="color:#66d9ef">IMPORTING</span>
     error        <span style="color:#f92672">=</span> error.
<span style="color:#66d9ef">IF</span> error<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>error_code <span style="color:#f92672">EQ</span> <span style="color:#e6db74">&#39;OPEN_DOCUMENT_FAILED&#39;</span>.
  <span style="color:#66d9ef">CALL METHOD</span> cl_gui_cfw<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>flush.
  <span style="color:#66d9ef">CALL METHOD</span> cl_gui_cfw<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>dispatch.
  <span style="color:#66d9ef">CALL METHOD</span> link_server<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stop_link_server
    <span style="color:#66d9ef">IMPORTING</span>
      error   <span style="color:#f92672">=</span> error
      retcode <span style="color:#f92672">=</span> retcode.
  <span style="color:#66d9ef">FREE</span>: control,link_server,document,error,bds_documents.
  <span style="color:#66d9ef">CALL METHOD</span> custom_container<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>free.
  <span style="color:#66d9ef">LEAVE TO SCREEN</span> <span style="color:#ae81ff">0</span>.
<span style="color:#66d9ef">ENDIF</span>.
</code></pre></div><h3 id="excel-操作">Excel 操作</h3>
<h4 id="获取文件操作接口">获取文件操作接口</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#75715e">*===== Get Spreadsheet Interface =====*</span>
<span style="color:#66d9ef">CALL METHOD</span> document<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>has_spreadsheet_interface
   <span style="color:#66d9ef">IMPORTING</span>
     is_available <span style="color:#f92672">=</span> is_available.
<span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> is_available <span style="color:#f92672">IS INITIAL</span>.
  <span style="color:#66d9ef">CALL METHOD</span> document<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>get_spreadsheet_interface.
<span style="color:#66d9ef">ENDIF</span>.
</code></pre></div><h4 id="操作excel文件">操作Excel文件</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">CALL METHOD</span> spreadsheet_interface<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>select_sheet
   <span style="color:#66d9ef">EXPORTING</span>
     name    <span style="color:#f92672">=</span> sel_sheetname
     no_flush <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
   <span style="color:#66d9ef">IMPORTING</span>
     error    <span style="color:#f92672">=</span> error
     retcode  <span style="color:#f92672">=</span> retcode.
<span style="color:#66d9ef">CALL METHOD</span> spreadsheet_interface<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>get_active_sheet
    <span style="color:#66d9ef">EXPORTING</span>
      no_flush  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
    <span style="color:#66d9ef">IMPORTING</span>
      sheetname <span style="color:#f92672">=</span> sheetname
      error    <span style="color:#f92672">=</span> error
      retcode  <span style="color:#f92672">=</span> retcode.
<span style="color:#66d9ef">CALL METHOD</span> spreadsheet_interface<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>add_sheet
   <span style="color:#66d9ef">EXPORTING</span>
     name    <span style="color:#f92672">=</span> add_sheetname
     no_flush <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
   <span style="color:#66d9ef">IMPORTING</span>
     error    <span style="color:#f92672">=</span> error
     retcode  <span style="color:#f92672">=</span> retcode.
<span style="color:#66d9ef">CALL METHOD</span> spreadsheet_interface<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>delete_sheet
   <span style="color:#66d9ef">EXPORTING</span>
     name    <span style="color:#f92672">=</span> del_sheetname
     no_flush <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
   <span style="color:#66d9ef">IMPORTING</span>
     error    <span style="color:#f92672">=</span> error
     retcode  <span style="color:#f92672">=</span> retcode.
<span style="color:#66d9ef">CALL METHOD</span> spreadsheet_interface<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>set_sheet_name
  <span style="color:#66d9ef">EXPORTING</span>
    newname  <span style="color:#f92672">=</span> new_sheetname
    oldname  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Sheet1&#39;</span>
    no_flush <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>.
</code></pre></div><h4 id="数据写入excel-">数据写入Excel</h4>
<p>数据写入Excel，可以使用批量的方式或者逐个单元格写入的方式。批量写入的方式效率高，逐个单元格写入的方式比较灵活。将数据写入 excel 需要使用 <code>i_oi_spreadsheet</code> 接口实例的两个方法：</p>
<ul>
<li>insert_range_dim：定义一个范围(range)，设定 range 的名称、位置和大小。</li>
<li>set_range_data：写入数据到 range，写入的时候，ranges 参数设定 range 的名称和大小，contents参数设定写入的内容。</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#75715e">*===== insert_range_dim:界定 ranges 范围 =====*</span>
<span style="color:#66d9ef">CALL METHOD</span> spreadsheet_interface<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>insert_range_dim
  <span style="color:#66d9ef">EXPORTING</span>
    name     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;cp&#39;</span>
    no_flush <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>
    top      <span style="color:#f92672">=</span> row <span style="color:#75715e">&#34;位置开始行&#34;
</span><span style="color:#75715e"></span>    left     <span style="color:#f92672">=</span> col <span style="color:#75715e">&#34;位置开始列&#34;
</span><span style="color:#75715e"></span>    rows     <span style="color:#f92672">=</span> rows_number    <span style="color:#75715e">&#34;Range 总行数&#34;
</span><span style="color:#75715e"></span>    columns  <span style="color:#f92672">=</span> columns_number <span style="color:#75715e">&#34;Range 总列数&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">IMPORTING</span>
    error    <span style="color:#f92672">=</span> error.
<span style="color:#66d9ef">REFRESH</span>: gt_ranges,gt_contents.
gs_range<span style="color:#f92672">-</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;cp&#39;</span>.
gs_range<span style="color:#f92672">-</span>columns <span style="color:#f92672">=</span> rows_number.
gs_range<span style="color:#f92672">-</span>rows <span style="color:#f92672">=</span> columns_number.
<span style="color:#66d9ef">APPEND</span> gs_range <span style="color:#66d9ef">TO</span> gt_ranges.
<span style="color:#75715e">*===== set_range_data =====*</span>
<span style="color:#66d9ef">DATA</span>: lv_row <span style="color:#66d9ef">TYPE </span>i,lv_column <span style="color:#66d9ef">TYPE </span>i.
<span style="color:#66d9ef">DATA</span>: lwa_fieldcat <span style="color:#66d9ef">TYPE </span>slis_fieldcat_alv.
<span style="color:#66d9ef">CLEAR</span> lv_column.
<span style="color:#66d9ef">LOOP AT </span>it_fieldcat <span style="color:#66d9ef">INTO</span> lwa_fieldcat.
  lv_column <span style="color:#f92672">=</span> lv_column <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>.
  gs_content<span style="color:#f92672">-</span>row <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>.
  gs_content<span style="color:#f92672">-</span>column <span style="color:#f92672">=</span> lv_column.
  gs_content<span style="color:#f92672">-</span>value  <span style="color:#f92672">=</span> lwa_fieldcat<span style="color:#f92672">-</span>seltext_l.
  <span style="color:#66d9ef">APPEND</span> gs_content <span style="color:#66d9ef">TO</span> gt_contents.
<span style="color:#66d9ef">ENDLOOP</span>.
<span style="color:#66d9ef">CALL METHOD</span> spreadsheet_interface<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>set_ranges_data
  <span style="color:#66d9ef">EXPORTING</span>
    <span style="color:#66d9ef">ranges</span>   <span style="color:#f92672">=</span> gt_ranges
    contents <span style="color:#f92672">=</span> gt_contents
    no_flush <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>
  <span style="color:#66d9ef">IMPORTING</span>
    error    <span style="color:#f92672">=</span> error.
<span style="color:#66d9ef">CALL METHOD</span> spreadsheet_interface<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>fit_widest
  <span style="color:#66d9ef">EXPORTING</span>
    name     <span style="color:#f92672">=</span> space
    no_flush <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>.
<span style="color:#66d9ef">REFRESH</span>: gt_ranges, gt_contents.
</code></pre></div><h3 id="对象销毁-">对象销毁</h3>
<p>PAI 的 exit-command 事件中对 spreadsheet、control 和 container 等对象进行销毁操作。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">MODULE</span> <span style="color:#a6e22e">exit_program</span> <span style="color:#66d9ef">INPUT</span>.
  save_ok <span style="color:#f92672">=</span> ok_code.
  <span style="color:#66d9ef">CLEAR</span> ok_code.
  <span style="color:#66d9ef">IF</span> save_ok <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;EXIT&#39;</span>.
    <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> document <span style="color:#f92672">IS INITIAL</span>.
      <span style="color:#66d9ef">CALL METHOD</span> document<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>close_document.
      <span style="color:#66d9ef">FREE </span>document.
    <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> control <span style="color:#f92672">IS INITIAL</span>.
      <span style="color:#66d9ef">CALL METHOD</span> control<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>destroy_control.
      <span style="color:#66d9ef">FREE </span>control.
    <span style="color:#66d9ef">endif</span>.
    <span style="color:#66d9ef">IF</span> <span style="color:#f92672">NOT</span> container <span style="color:#f92672">IS INITIAL</span>.
      <span style="color:#66d9ef">CALL METHOD</span> container<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>free.
    <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">LEAVE</span> <span style="color:#66d9ef">PROGRAM</span>.
  <span style="color:#66d9ef">ENDIF</span>.
<span style="color:#66d9ef">ENDMODULE</span>.
</code></pre></div><h3 id="错误处理-">错误处理</h3>
<h4 id="第一种方法">第一种方法</h4>
<p>使用 c_oi_errors 的静态方法 raise_message 简单地显示相关的错误：type 可以是 A, E, W, I, S 其中之一。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">CALL METHOD</span> C_OI_ERRORS<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>RAISE_MESSAGE
    <span style="color:#66d9ef">EXPORTING</span>
       TYPE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;E&#39;</span>.
</code></pre></div><h4 id="第二种方法">第二种方法</h4>
<p>区分不同的错误，给用户一个更明确的提示。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">IF</span> ret_code <span style="color:#f92672">EQ</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_ok.
  <span style="color:#75715e">&#34; Document opened successfully &#34;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">ELSEIF</span> ret_code <span style="color:#f92672">EQ</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>ret_document_already_open.
  <span style="color:#75715e">&#34; Special error handling, e.g. dialog box.&#34;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">ELSE</span>.
  <span style="color:#66d9ef">CALL METHOD</span> c_oi_errors<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>raise_message
    <span style="color:#66d9ef">EXPORTING</span> 
      type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;E&#39;</span>.
<span style="color:#66d9ef">ENDIF</span>.
</code></pre></div><h4 id="集中处理">集中处理</h4>
<p>因为 Excel 操作多个步骤，为了在过程中间减少对用户的干扰，也可以把 <code>ret_code</code> 返回的错误码先储存在内表中，集中处理。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">DATA</span>: errors <span style="color:#66d9ef">TYPE REF TO</span> i_oi_error OCCURS <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">HEADER LINE</span>.
<span style="color:#75715e">* DOI processing</span>
<span style="color:#66d9ef">CALL METHOD</span> control<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>get_link_server
  <span style="color:#66d9ef">EXPORTING</span> server_type <span style="color:#f92672">=</span> server_type
    no_flush <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>
  <span style="color:#66d9ef">IMPORTING</span> link_server <span style="color:#f92672">=</span> link_server
    retcode <span style="color:#f92672">=</span> retcode
    error <span style="color:#f92672">=</span> errors.
<span style="color:#66d9ef">APPEND</span> errors.
<span style="color:#66d9ef">LOOP AT </span>errors. 
  <span style="color:#66d9ef">CALL METHOD</span> errors<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>raise_message
    <span style="color:#66d9ef">EXPORTING</span>
	  type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;E&#39;</span>
    <span style="color:#66d9ef">EXCEPTIONS</span> 
      message_raised <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
      flush_failed <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>.
<span style="color:#66d9ef">ENDLOOP</span>.
<span style="color:#66d9ef">FREE </span>errors.
</code></pre></div><h2 id="其他实现-">其他实现</h2>
<h3 id="1-如何根据屏幕大小让-excel-自适应-">1. 如何根据屏幕大小让 Excel 自适应</h3>
<p>使用：splitter</p>
<p>在 container control 初始化的时候，设定 parent 为 splitter 生成的 container。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">DATA</span>: container <span style="color:#66d9ef">type ref to</span> cl_gui_container,
      splitter  <span style="color:#66d9ef">type ref to</span> cl_gui_splitter_container,
    ......
<span style="color:#66d9ef">FORM</span> <span style="color:#a6e22e">get_dynamic_container</span>.
  <span style="color:#66d9ef">CREATE OBJECT</span> splitter
    <span style="color:#66d9ef">EXPORTING</span>
      parent  <span style="color:#f92672">=</span> cl_gui_container<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>screen0
      rows    <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
      columns <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>.
  <span style="color:#66d9ef">CALL METHOD</span> splitter<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>set_border
    <span style="color:#66d9ef">EXPORTING</span>
      border <span style="color:#f92672">=</span> cl_gui_cfw<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span>false.
  container <span style="color:#f92672">=</span> splitter<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">get_container</span>( row <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> column <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> ).
<span style="color:#66d9ef">ENDFORM</span>.                    <span style="color:#75715e">&#34; GET_DYNAMIC_CONTAINER &#34;
</span></code></pre></div><h3 id="2-excel-单个单元格写入-">2. Excel 单个单元格写入</h3>
<p>单个单元格写入的方法，同批量写入一样，使用 i_oi_spreadsheet 接口的 set_range_dim 方法和 set_range_data方法。区别在于 range 只包含一行一列。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">FORM</span> <span style="color:#a6e22e">write_single_cell</span> <span style="color:#66d9ef">USING</span> p_row p_col p_value.
<span style="color:#75715e">* define internal table for ranges and contents parameters</span>
  <span style="color:#66d9ef">DATA</span>: lt_ranges <span style="color:#66d9ef">TYPE </span>soi_range_list,
        ls_rangeitem <span style="color:#66d9ef">TYPE </span>soi_range_item,
        lt_contents <span style="color:#66d9ef">TYPE </span>soi_generic_table,
        ls_content <span style="color:#66d9ef">TYPE </span>soi_generic_item.
<span style="color:#75715e">* populate ranges</span>
  <span style="color:#66d9ef">CLEAR</span> ls_rangeitem.
  <span style="color:#66d9ef">CLEAR</span> lt_ranges[].
  ls_rangeitem<span style="color:#f92672">-</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;cp&#39;</span> .
  ls_rangeitem<span style="color:#f92672">-</span>columns <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>.
  ls_rangeitem<span style="color:#f92672">-</span>rows <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>.
  ls_rangeitem<span style="color:#f92672">-</span>code <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>.
  <span style="color:#66d9ef">APPEND</span> ls_rangeitem <span style="color:#66d9ef">TO</span> lt_ranges.
<span style="color:#75715e">* populate contents</span>
  <span style="color:#66d9ef">CLEAR</span> ls_content.
  <span style="color:#66d9ef">CLEAR</span> lt_contents[].
  ls_content<span style="color:#f92672">-</span>column <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>.
  ls_content<span style="color:#f92672">-</span>row <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>.
  ls_content<span style="color:#f92672">-</span>value <span style="color:#f92672">=</span> p_value.
  <span style="color:#66d9ef">APPEND</span> ls_content <span style="color:#66d9ef">TO</span> lt_contents.
<span style="color:#75715e">* 每次只写一行一列</span>
  <span style="color:#66d9ef">CALL METHOD</span> spreadsheet_interface<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>insert_range_dim
    <span style="color:#66d9ef">EXPORTING</span>
      name     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;cp&#39;</span>
      no_flush <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>
      top      <span style="color:#f92672">=</span> p_row
      left     <span style="color:#f92672">=</span> p_col
      rows     <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
      columns  <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>.
  <span style="color:#66d9ef">CALL METHOD</span> spreadsheet_interface<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>set_ranges_data
    <span style="color:#66d9ef">EXPORTING</span>
      <span style="color:#66d9ef">ranges</span>   <span style="color:#f92672">=</span> lt_ranges
      contents <span style="color:#f92672">=</span> lt_contents
      no_flush <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>.
<span style="color:#66d9ef">ENDFORM</span>.   
<span style="color:#75715e">* 循环写入</span>
<span style="color:#66d9ef">LOOP AT </span>gt_spfli <span style="color:#66d9ef">INTO</span> gs_spfli.
   row_index <span style="color:#f92672">=</span> sy<span style="color:#f92672">-</span>tabix <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>.
   <span style="color:#66d9ef">PERFORM</span> <span style="color:#a6e22e">write_single_cell</span> <span style="color:#66d9ef">USING</span> row_index <span style="color:#ae81ff">1</span> gs_spfli<span style="color:#f92672">-</span>carrid.
   <span style="color:#66d9ef">PERFORM</span> <span style="color:#a6e22e">write_single_cell</span> <span style="color:#66d9ef">USING</span> row_index <span style="color:#ae81ff">2</span> gs_spfli<span style="color:#f92672">-</span>connid.
   <span style="color:#66d9ef">PERFORM</span> <span style="color:#a6e22e">write_single_cell</span> <span style="color:#66d9ef">USING</span> row_index <span style="color:#ae81ff">3</span> gs_spfli<span style="color:#f92672">-</span>cityfrom.
   <span style="color:#66d9ef">PERFORM</span> <span style="color:#a6e22e">write_single_cell</span> <span style="color:#66d9ef">USING</span> row_index <span style="color:#ae81ff">4</span> gs_spfli<span style="color:#f92672">-</span>cityto.
   <span style="color:#66d9ef">CLEAR</span> gs_spfli.
<span style="color:#66d9ef">ENDLOOP</span>.
</code></pre></div><h3 id="3-设置-excel-属性-">3. 设置 Excel 属性</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">FORM</span> <span style="color:#a6e22e">set_excel_attributes</span>.
<span style="color:#75715e">* set border line for range</span>
  <span style="color:#66d9ef">CALL METHOD</span> spreadsheet_interface<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>set_frame
    <span style="color:#66d9ef">EXPORTING</span>
      rangename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;cp&#39;</span>
      typ       <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;127&#39;</span>
      <span style="color:#66d9ef">color</span>     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span>
      no_flush  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>.
<span style="color:#75715e">* set font</span>
  <span style="color:#66d9ef">CALL METHOD</span> spreadsheet_interface<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>set_font
    <span style="color:#66d9ef">EXPORTING</span>
      rangename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;cp&#39;</span>
      family    <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Times New Roman&#39;</span>
      <span style="color:#66d9ef">size</span>      <span style="color:#f92672">=</span> <span style="color:#ae81ff">9</span>
      bold      <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
      italic    <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
      <span style="color:#66d9ef">align</span>     <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">IMPORTING</span>
      error     <span style="color:#f92672">=</span> error
      retcode   <span style="color:#f92672">=</span> retcode.
<span style="color:#75715e">* set format</span>
  <span style="color:#66d9ef">call method</span> spreadsheet_interface<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>set_format
    <span style="color:#66d9ef">exporting</span>
      rangename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;cp&#39;</span>
      typ       <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
      <span style="color:#66d9ef">currency</span>  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;RMB&#39;</span>
    <span style="color:#66d9ef">importing</span>
      error     <span style="color:#f92672">=</span> error
      retcode   <span style="color:#f92672">=</span> retcode.
<span style="color:#75715e">* auto fit</span>
  <span style="color:#66d9ef">CALL METHOD</span> spreadsheet_interface<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>fit_widest
    <span style="color:#66d9ef">EXPORTING</span>
      name    <span style="color:#f92672">=</span> space
      no_flush <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;X&#39;</span>.
<span style="color:#66d9ef">ENDFORM</span>.   
</code></pre></div><h3 id="4金额数字格式转换">4.金额数字格式转换</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">FORM</span> <span style="color:#a6e22e">frm_output_format</span> <span style="color:#66d9ef">USING</span> l_num <span style="color:#66d9ef">CHANGING</span> l_result.
  <span style="color:#66d9ef">DATA</span>:l_amt(<span style="color:#ae81ff">17</span>),
       l_int(<span style="color:#ae81ff">10</span>),
       l_char(<span style="color:#ae81ff">17</span>),
       l_fac(<span style="color:#ae81ff">2</span>),
       l_len <span style="color:#66d9ef">TYPE </span>i,
       l_count <span style="color:#66d9ef">TYPE </span>i,
       l_pos <span style="color:#66d9ef">TYPE </span>i,
       l_rest <span style="color:#66d9ef">TYPE </span>i,
       l_time <span style="color:#66d9ef">TYPE </span>i.
  <span style="color:#66d9ef">CONSTANTS</span>: c_tab <span style="color:#66d9ef">VALUE</span> <span style="color:#e6db74">&#39;,&#39;</span>,
             c_pot <span style="color:#66d9ef">VALUE</span> <span style="color:#e6db74">&#39;.&#39;</span>.
  <span style="color:#66d9ef">CLEAR</span> l_amt.
  <span style="color:#66d9ef">IF</span> l_num <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>.
    l_amt <span style="color:#f92672">=</span> ABS( l_num ).
    <span style="color:#66d9ef">CONDENSE</span> l_amt.
    <span style="color:#66d9ef">SPLIT</span> l_amt <span style="color:#66d9ef">AT</span> c_pot <span style="color:#66d9ef">INTO</span> l_int l_fac.
    l_len <span style="color:#f92672">=</span> STRLEN( l_int ).
    l_count <span style="color:#f92672">=</span> l_len.
    l_rest <span style="color:#f92672">=</span> l_len MOD <span style="color:#ae81ff">3</span>.
    <span style="color:#66d9ef">IF</span> l_rest <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>.
      l_time <span style="color:#f92672">=</span> l_len DIV <span style="color:#ae81ff">3</span>.
    <span style="color:#66d9ef">ELSE</span>.
      l_time <span style="color:#f92672">=</span> l_len DIV <span style="color:#ae81ff">3</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>.
    <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">DO</span> l_time <span style="color:#66d9ef">TIMES</span>.
      l_count <span style="color:#f92672">=</span> l_count <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>.
      <span style="color:#66d9ef">IF</span> l_count <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>.
        <span style="color:#66d9ef">CONCATENATE</span> c_tab l_int<span style="color:#f92672">+</span>l_count(<span style="color:#ae81ff">3</span>) l_char <span style="color:#66d9ef">INTO</span> l_char.
      <span style="color:#66d9ef">ELSEIF</span> l_count <span style="color:#f92672">&lt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>.
        l_count <span style="color:#f92672">=</span> l_count <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>.
        <span style="color:#66d9ef">CONCATENATE</span> l_int<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>(l_count) l_char <span style="color:#66d9ef">INTO</span> l_char.
        <span style="color:#66d9ef">EXIT</span>.
      <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">ENDDO</span>.
    <span style="color:#66d9ef">CLEAR</span> l_len.
    l_len <span style="color:#f92672">=</span> STRLEN( l_fac ).
    <span style="color:#66d9ef">IF</span> l_fac <span style="color:#f92672">IS INITIAL</span>.
      <span style="color:#66d9ef">CONCATENATE</span> l_char <span style="color:#e6db74">&#39;.00&#39;</span> <span style="color:#66d9ef">INTO</span> l_result.
    <span style="color:#66d9ef">ELSEIF</span> l_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>.
      <span style="color:#66d9ef">CONCATENATE</span> l_char <span style="color:#e6db74">&#39;.&#39;</span> l_fac <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">INTO</span> l_result.
    <span style="color:#66d9ef">ELSEIF</span> l_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>.
      <span style="color:#66d9ef">CONCATENATE</span> l_char <span style="color:#e6db74">&#39;.&#39;</span> l_fac <span style="color:#66d9ef">INTO</span> l_result.
    <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">CONDENSE</span> l_result.
  <span style="color:#66d9ef">ELSEIF</span> l_num <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>.

    l_amt <span style="color:#f92672">=</span> ABS( l_num ).
    <span style="color:#66d9ef">CONDENSE</span> l_amt.
    <span style="color:#66d9ef">SPLIT</span> l_amt <span style="color:#66d9ef">AT</span> c_pot <span style="color:#66d9ef">INTO</span> l_int l_fac.
    l_len <span style="color:#f92672">=</span> STRLEN( l_int ).
    l_count <span style="color:#f92672">=</span> l_len.
    l_rest <span style="color:#f92672">=</span> l_len MOD <span style="color:#ae81ff">3</span>.
    <span style="color:#66d9ef">IF</span> l_rest <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>.
      l_time <span style="color:#f92672">=</span> l_len DIV <span style="color:#ae81ff">3</span>.
    <span style="color:#66d9ef">ELSE</span>.
      l_time <span style="color:#f92672">=</span> l_len DIV <span style="color:#ae81ff">3</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>.
    <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">DO</span> l_time <span style="color:#66d9ef">TIMES</span>.
      l_count <span style="color:#f92672">=</span> l_count <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>.
      <span style="color:#66d9ef">IF</span> l_count <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>.
        <span style="color:#66d9ef">CONCATENATE</span> c_tab l_int<span style="color:#f92672">+</span>l_count(<span style="color:#ae81ff">3</span>) l_char <span style="color:#66d9ef">INTO</span> l_char.
      <span style="color:#66d9ef">ELSEIF</span> l_count <span style="color:#f92672">&lt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>.
        l_count <span style="color:#f92672">=</span> l_count <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>.
        <span style="color:#66d9ef">CONCATENATE</span> l_int<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>(l_count) l_char <span style="color:#66d9ef">INTO</span> l_char.
        <span style="color:#66d9ef">EXIT</span>.
      <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">ENDDO</span>.
    <span style="color:#66d9ef">CLEAR</span> l_len.
    l_len <span style="color:#f92672">=</span> STRLEN( l_fac ).
    <span style="color:#66d9ef">IF</span> l_fac <span style="color:#f92672">IS INITIAL</span>.
      <span style="color:#66d9ef">CONCATENATE</span> <span style="color:#e6db74">&#39;-&#39;</span> l_char <span style="color:#e6db74">&#39;.00&#39;</span> <span style="color:#66d9ef">INTO</span> l_result.
    <span style="color:#66d9ef">ELSEIF</span> l_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>.
      <span style="color:#66d9ef">CONCATENATE</span> <span style="color:#e6db74">&#39;-&#39;</span> l_char <span style="color:#e6db74">&#39;.&#39;</span> l_fac <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#66d9ef">INTO</span> l_result.
    <span style="color:#66d9ef">ELSEIF</span> l_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>.
      <span style="color:#66d9ef">CONCATENATE</span> <span style="color:#e6db74">&#39;-&#39;</span> l_char <span style="color:#e6db74">&#39;.&#39;</span> l_fac <span style="color:#66d9ef">INTO</span> l_result.
    <span style="color:#66d9ef">ENDIF</span>.
    <span style="color:#66d9ef">CONDENSE</span> l_result.
  <span style="color:#66d9ef">ELSE</span>.
    l_result <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0.00&#39;</span>.
  <span style="color:#66d9ef">ENDIF</span>.
<span style="color:#66d9ef">ENDFORM</span>.                    <span style="color:#75715e">&#34;frm_output_format&#34;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">DATA</span>: l_amt(<span style="color:#ae81ff">20</span>) <span style="color:#66d9ef">TYPE </span>c,
      l_amt_doccur <span style="color:#66d9ef">TYPE </span>DMBTR.
<span style="color:#66d9ef">PERFORM</span> <span style="color:#a6e22e">frm_output_format</span> <span style="color:#66d9ef">USING</span>     l_amt_doccur
                          <span style="color:#66d9ef">CHANGING</span>  l_amt.
</code></pre></div><p>参考文章</p>
<ul>
<li>
<p><a href="https://blog.csdn.net/SAPmatinal/article/details/52776862">ABAP DOI展示EXCEL或WORD </a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/stone0823/article/details/53819960">ABAP DOI详解</a></p>
</li>
</ul>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>Small Fire </span>
                </p>
            
           
            <p class="copyright-item">
                    <span>Words:</span>
                   <span>4690</span>
            </p>
            
            <p class="copyright-item">
                
            </p>

            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-icon-tag"></i>Tag: 
            
            <span class="tag"><a href="https://coldinfire.github.io/tags/abaputils/">
                    #abaputils</a></span>
            
            <span class="tag"><a href="https://coldinfire.github.io/tags/ALV/">
                    #ALV</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">Back</a></span> · 
                <span><a href="https://coldinfire.github.io">Home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://coldinfire.github.io/2019/SAP_Utils_Webservice/" class="prev" rel="prev" title=" SAP Webservice 使用 "><i class="iconfont icon-dajiantou"></i>&nbsp; SAP Webservice 使用 </a>
         
        
        <a href="https://coldinfire.github.io/2019/ABAP_Memory/" class="next" rel="next" title=" SAP Memory 使用 "> SAP Memory 使用 &nbsp;<i class="iconfont icon-xiaojiantou"></i></a>
        
    </div>

    <div class="post-comment">
          
          <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2019-02-22 00:00:00 \x2b0000 UTC',
        title: ' ABAP DOI 使用 ',
        clientID: 'd2cccd8844ae11b05792',
        clientSecret: 'cea63bc294ee16cb47a3344b693c350da1bb0753',
        repo: 'coldinfire.github.io',
        owner: 'coldinfire',
        admin: ['coldinfire'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>
  


          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2017 - 2022</span>
        
         
            <span class="author" itemprop="copyrightHolder"><a href="https://coldinfire.github.io">Small Fire</a> | </span>
         

		  <span>Crafted with ❤️ by <a href="https://github.com/Fastbyte01/KeepIt" target="_blank" rel="external nofollow noopener noreffer">KeepIt</a> & <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreffer">Hugo</a></span>
    </div>
</footer>












    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  







     </div>
  </body>
</html>
