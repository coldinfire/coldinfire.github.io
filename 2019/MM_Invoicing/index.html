<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  
  
  
  
  
  <link rel="prev" href="https://coldinfire.github.io/2019/PP_Process_1/" />
  <link rel="next" href="https://coldinfire.github.io/2019/ABAP_SALV_Basis/" />
  <link rel="canonical" href="https://coldinfire.github.io/2019/MM_Invoicing/" />
  <link rel='shortcut icon' type='image/x-icon' href='/favicon.ico' />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
            SAP 进销存难点分析及对策  | Small Fire`s Blog
       
  </title>
  <meta name="title" content=" SAP 进销存难点分析及对策  | Small Fire`s Blog">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=" SAP 进销存难点分析及对策 "/>
<meta name="twitter:description" content="引用链接：https://blog.csdn.net/wbin9752/article/details/8608765#comments_2"/>

  <script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": " SAP 进销存难点分析及对策 ",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https:\/\/coldinfire.github.io\/2019\/MM_Invoicing\/"
  },
  "image": {
    "@type": "ImageObject",
    "url": "https:\/\/coldinfire.github.io\/cover.png",
    "width":  800 ,
    "height":  600 
  },
  "genre": "posts",
  "keywords": "MM",
  "wordcount":  2011 ,
  "url": "https:\/\/coldinfire.github.io\/2019\/MM_Invoicing\/",
  "datePublished": "2019-05-29T00:00:00\x2b00:00",
  "dateModified": "2019-05-29T00:00:00\x2b00:00",
  
  "publisher": {
    "@type": "Organization",
    "name": "SmallFire",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/coldinfire.github.io\/logo.png",
      "width":  127 ,
      "height":  40 
    }
  },
  "author": {
    "@type": "Person",
    "name": "Small Fire"
  },
  "description": ""
}
</script>
</head>

  



  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="https://coldinfire.github.io">Small Fire`s Blog</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/books/" title="">Books</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
                <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-sun"></i></a>&nbsp;
                <a href="/search/" class="search"><i class="iconfont icon-t"></i></a>&nbsp;
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-sun"></i></a>&nbsp;<a href="https://coldinfire.github.io">Small Fire`s Blog</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/books/" title="">Books</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>

    	 <main class="main">
          <div class="container">
      		
<article class="post-warp">
    <header class="post-header">
        <h1 class="post-title"> SAP 进销存难点分析及对策 </h1>
        <div class="post-meta">
            Written by <a href="https://coldinfire.github.io" rel="author">Small Fire</a> with ♥ 
                <span class="post-time">
                    on <time datetime=2019-05-29 >29 May 2019</time>
                </span>
                in
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        <a href="https://coldinfire.github.io/categories/ABAP/"> ABAP </a>
                        
                </span>
                <i class="iconfont icon-timer"></i>
                5 min
        </div>
    </header>
    <div class="post-content">
        

        
            
        

        
        
     
          
          
          

          
          
          

          <p>引用链接：<a href="https://blog.csdn.net/wbin9752/article/details/8608765#comments_2539308">https://blog.csdn.net/wbin9752/article/details/8608765#comments_2539308</a></p>
<h3 id="为什么需要开发自定义的进销存报表">为什么需要开发自定义的进销存报表</h3>
<p>既然 SAP 有了 MB51，MB5B 等报表，既可以查实时库存，又可以查询历史期间的期初期末库存，还可以查询指定时间段内的收发货数量与金额，为什么很多企业里尤其是民营企业里还要开发自己的进销存报表呢？</p>
<p>首先是因为各个企业里有企业特殊需求。</p>
<p>优化后的进销存报表也是要显示期初余额，期初库存数量，入库数量与金额，出库数量与金额，期末数量与金额等栏位；同时对入库与出库，根据业务部门关注的重点做了几个细分，比如入库再细分采购入库，工单入库和其它入库；出库则再细分为销售出库，工单发料和其它出库。这些都是企业特定的需求，使用报表的业务部门尤其关注点，所以报表需要支持这些关注点。<em>MB5B</em>  报表对于这些需求的支持显然不太给力。</p>
<p>其次还因为企业还有特定行业要求。</p>
<p>由于产品所在行业的特殊性，业务部门除了关心出入库数量与金额以外，还关心出入库的面积与重量以及期初期末面积与重量。并且由于客户使用了可配置物料，这些物料的单个面积不固定，而是根据不同销售订单里相关长宽特性值的不同而不同。类似这种需求，标准的 <em>MB5B</em> 报表当然更是无法支持。</p>
<p>更重要的原因是，MB5B 报表里对于收发货数量与金额栏位的统计口径并不科学，不能满足企业常规的需求。比如其总收发货数量栏位值的计算逻辑，除了包括常规收发货数量以外，还包括收货的取消，采购订单退货的数量等。</p>
<h3 id="sap标准程序逻辑分析">SAP标准程序逻辑分析</h3>
<h4 id="mc9-取数逻辑">MC.9 取数逻辑</h4>
<p>MC.9 取数逻辑基于 S031 和 S032 两个信息结构可以取的某个月底库存数量金库存金额，其中 S032 表记录当前库存数量及金额，S031 表记录过去某个时间段的入库数量、金额及出库数量及金额，然后采用倒推方式计算出过去某个时点（按月）的库存数量及金额。</p>
<p><img src="/images/MM/Inventory_MC.9.jpg" alt="MC.9 Logic"></p>
<p>优点：如果查询数据量较小时，数据提取效率快且准确。</p>
<p>缺点：由于采用倒推方式，一旦查询数据量较大，查询时段如果有出入库操作，数据可能不准。</p>
<h4 id="mb51-取数逻辑">MB51 取数逻辑</h4>
<p>MB51 查询某个时间段内出入库记录，基于 MKPF 和 MSEG 进行取数。</p>
<p>优点：能够准确查询某个时间段内出、入库记录。</p>
<p>缺点：MB51 不能记录价格修改、发票校验差异对存货价值影响，不能保持和总账一致。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ABAP" data-lang="ABAP"><span style="color:#66d9ef">select</span> (g_t_fields)
  <span style="color:#66d9ef">into</span> <span style="color:#66d9ef">corresponding fields of</span> <span style="color:#66d9ef">table</span> itab
  <span style="color:#66d9ef">from</span> mkpf inner <span style="color:#66d9ef">join</span> mseg <span style="color:#66d9ef">on</span> mkpf~mandt <span style="color:#f92672">=</span> mseg~mandt
    <span style="color:#f92672">and</span> mkpf~mblnr <span style="color:#f92672">=</span> mseg~mblnr
    <span style="color:#f92672">and</span> mkpf~mjahr <span style="color:#f92672">=</span> mseg~mjahr
    <span style="color:#66d9ef">for</span> all entries <span style="color:#66d9ef">in</span> matnr
  <span style="color:#66d9ef">where</span> matnr <span style="color:#f92672">=</span> matnr<span style="color:#f92672">-</span>low
    <span style="color:#f92672">and</span> MKPF~BUDAT <span style="color:#66d9ef">in</span> BUDAT
    <span style="color:#f92672">and</span> MSEG~BWART <span style="color:#66d9ef">in</span> BWART
    <span style="color:#f92672">and</span> MSEG~CHARG <span style="color:#66d9ef">in</span> CHARG
    <span style="color:#f92672">and</span> MSEG~KUNNR <span style="color:#66d9ef">in</span> KUNNR
    <span style="color:#f92672">and</span> MSEG~LGORT <span style="color:#66d9ef">in</span> LGORT
    <span style="color:#f92672">and</span> MSEG~LIFNR <span style="color:#66d9ef">in</span> LIFNR
    <span style="color:#f92672">and</span> MSEG~SOBKZ <span style="color:#66d9ef">in</span> SOBKZ
    <span style="color:#f92672">and</span> MKPF~USNAM <span style="color:#66d9ef">in</span> USNAM
    <span style="color:#f92672">and</span> MKPF~VGART <span style="color:#66d9ef">in</span> VGART
    <span style="color:#f92672">and</span> MSEG~WERKS <span style="color:#66d9ef">in</span> WERKS
    <span style="color:#f92672">and</span> MKPF~XBLNR <span style="color:#66d9ef">in</span> XBLNR
    <span style="color:#960050;background-color:#1e0010">%</span>_HINTS
    ORACLE <span style="color:#e6db74">&#39;&amp;SUBSTITUTE VALUES&amp;&#39;</span> .
</code></pre></div><h4 id="mb5b-取数逻辑">MB5B 取数逻辑</h4>
<p>MB5B 取数主要基于 MARD、MBEW、BSIM、MKPF、MSEG 这五张数据表，与 MC.9 类似，采用倒推逻辑并依据 MARD、MKPF、MSEG 计算某个时间段期初数量、借方数量、贷方数量、期末数量，依据 MBEW、BSIM 计算某个时间段期初价值、借方价值、贷方价值、期末价值。</p>
<p>由于 MKPF、MSEG 依据 MB51 逻辑，不能记录价格修改、发票校验差异对存货价值影响，而 BSIM 只记录有价值更新的出入库记录，对免费入库类（只有数量更新无价值更新）不能记录，二者各有利弊。数量取数逻辑如下：</p>
<p><img src="/images/MM/Inventory_MB5B_Qty.jpg" alt="MB5B Qty Logic"></p>
<p>价值取数逻辑如下：</p>
<p><img src="/images/MM/Inventory_MB5B_Valued.jpg" alt="MB5B Qty Logic"></p>
<p>优点：既考虑数量、又考虑价值，如果查询数据量较少，数据比较全面且准确。</p>
<p>缺点：①查询速度慢；②借、贷方不能反映出、入库类型；③采用倒推方式，查询大数据量时，数据可能不准确。</p>
<h3 id="自开发程序设计逻辑">自开发程序设计逻辑</h3>
<p>SAP 标准程序 MC.9、MB5B 采用倒推逻辑，查询大数据量可能导致数据不准确，由于本集团工厂有 60 个左右，查询数据量大不可避免，鉴于以上原因不采用倒推逻辑。大概设计思路：从 MBEWH、S031 表直接取得期初库存数量及价值，然后从 MKPF、MSEG、BSIM 取得期间出入库数量及价值，依据期初数量、价值及当期出入库数量、价值计算期末数量及价值。</p>
<ul>
<li>如果一张发票校验，因为价格差异导致库存变动的话，它对应的财务凭证会出现在 BSIM 表里。</li>
</ul>
<h4 id="期初数量价值计算">期初数量，价值计算</h4>
<p>首先，介绍 MBEWH 表更新逻辑：如果第 N 月有一笔出入库或价值更新操作，系统会将 N-1 月月底数量及价值更新至 MBEWH 表。</p>
<p>假定要查 2012-12 月进销存，首先从 MBEWH 表取年度小于等于 2012 所有数据，然后删除年度等于 2012、月份大于等于 12 数据。经过数据处理后，依据物料、评估范围取得年度 + 月份最大的那条记录。</p>
<p>其次，计算取得数据下个月份（如：3100101001 取到 2012-09 这条数据下月为 2012-10），并和查询月份（2012-12）比较，如果二者不相等，从 S031 表取该时间段内（2012-10）出入库记录。将 MBEWH、S031 数据合并即为该物料 2012-12 期初数据。(为什么这样计算，仔细想想 MBEWH 更新逻辑)。</p>
<h4 id="期间入库出库数据计算">期间入库、出库数据计算</h4>
<p>然后，依据 MKPF、MSEG、BSIM 提取 2012-12 该月的出入库记录及价值更新记录。根据移动类型判断该记录属于入库或出库。</p>
<p>期末数据可以依据期初数据和当期出入库计算。这样设计采用正推逻辑，避免查询时有出入库操作对查询结果的影响；此程序既考虑了库存数量更新，又考虑了价值更新，保证了数据的全面性；这样就可保证进销存和总账一致，满足业务需求。</p>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>Small Fire </span>
                </p>
            
           
            <p class="copyright-item">
                    <span>Words:</span>
                   <span>2011</span>
            </p>
            
            <p class="copyright-item">
                
            </p>

            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-icon-tag"></i>Tag: 
            
            <span class="tag"><a href="https://coldinfire.github.io/tags/MM/">
                    #MM</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">Back</a></span> · 
                <span><a href="https://coldinfire.github.io">Home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://coldinfire.github.io/2019/PP_Process_1/" class="prev" rel="prev" title=" PP 基本流程 "><i class="iconfont icon-dajiantou"></i>&nbsp; PP 基本流程 </a>
         
        
        <a href="https://coldinfire.github.io/2019/ABAP_SALV_Basis/" class="next" rel="next" title=" SALV 使用简介 "> SALV 使用简介 &nbsp;<i class="iconfont icon-xiaojiantou"></i></a>
        
    </div>

    <div class="post-comment">
          
          <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2019-05-29 00:00:00 \x2b0000 UTC',
        title: ' SAP 进销存难点分析及对策 ',
        clientID: 'd2cccd8844ae11b05792',
        clientSecret: 'cea63bc294ee16cb47a3344b693c350da1bb0753',
        repo: 'coldinfire.github.io',
        owner: 'coldinfire',
        admin: ['coldinfire'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>
  


          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2017 - 2022</span>
        
         
            <span class="author" itemprop="copyrightHolder"><a href="https://coldinfire.github.io">Small Fire</a> | </span>
         

		  <span>Crafted with ❤️ by <a href="https://github.com/Fastbyte01/KeepIt" target="_blank" rel="external nofollow noopener noreffer">KeepIt</a> & <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreffer">Hugo</a></span>
    </div>
</footer>












    
     <link href="//lib.baomitu.com/lightgallery/1.6.12/css/lightgallery.min.css" rel="stylesheet">  
      
     <script src="/js/vendor_gallery.min.js" async="" ></script>
    
  







     </div>
  </body>
</html>
